# Session Retrospective: Forum Model & Author Fix

**Date**: 2026-01-03 23:10 GMT+7
**Duration**: ~30 minutes
**Focus**: Fix forum author display + add model parameter
**Energy**: Winding down

---

## Summary

Fixed the Oracle Forum author attribution system. Messages from Claude via MCP now show `ðŸ¤– opus@oracle-v2` instead of `ðŸ’¬ user`. Added explicit `model` parameter to `oracle_thread` MCP tool since Claude Code doesn't expose model info to MCP servers.

---

## What We Fixed

### 1. Author Display Bug
- **Problem**: All messages showed "ðŸ’¬ user" regardless of source
- **Cause**: Old `getCallerContext()` used unreliable `process.argv` detection
- **Fix**: Simplified to use `role` directly:
  - `role='claude'` â†’ author from model param
  - `role='human'` â†’ author = 'user'

### 2. Model Parameter
- **Problem**: Can't distinguish Opus from Sonnet in forum
- **Solution**: Added `model` param to `oracle_thread` MCP tool
- **Result**: `ðŸ¤– opus@oracle-v2` or `ðŸ¤– sonnet@oracle-v2`

### 3. UI Display Logic
- **Changed**: Role-based icons instead of generic "Question"
  - `ðŸ”® Oracle` for oracle responses
  - `ðŸ¤– model@project` for Claude
  - `ðŸ‘¤ user` for humans

---

## AI Diary

Short session to fix a bug the user noticed - forum messages from Claude were showing as "user" instead of the actual model. The root cause was an attempt to auto-detect MCP calls via `process.argv.includes('index.ts')` which doesn't work reliably.

The fix was simple once I understood it: just trust the `role` parameter. MCP calls pass `role='claude'`, HTTP calls pass `role='human'`. No magic detection needed.

Adding the `model` parameter was the user's idea - they wanted to distinguish Opus from Sonnet. Makes sense for a knowledge base to track which model contributed what insights.

The project context detection (`@oracle-v2`) works because the MCP server runs from the project directory and ghq path detection picks it up.

---

## Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Model detection | Explicit param | Claude Code doesn't expose model to MCP |
| Author format | `model@project` | Clear source attribution |
| Role usage | Trust the caller | Simpler than process.argv hacks |

---

## Files Changed

### Modified (4)
```
src/forum/handler.ts      - Simplified getCallerContext, use role+model
src/forum/types.ts        - Added model field to OracleThreadInput
src/index.ts              - Added model param to MCP tool schema
frontend/src/pages/Forum.tsx - Fixed display logic, removed unused fn
```

---

## Test Results

- **Build**: Passes
- **MCP test**: `oracle_thread` with `model: "opus"` â†’ `author: "opus@oracle-v2"`
- **DB verified**: Message correctly stored with role=claude, author=opus@oracle-v2

---

## Honest Feedback

### What Worked Well
- User caught the bug quickly ("why human?")
- Simple fix once root cause identified
- Model param adds real value for tracking

### What Could Be Better
- Should have noticed the process.argv approach was fragile earlier
- Old data in DB still has wrong authors (no migration)

### Surprises
- Project detection worked even though I expected it to fail
- `oracle_stats` already had version field

---

## Session Stats

| Metric | Value |
|--------|-------|
| Duration | ~30 min |
| Files modified | 4 |
| Bug fixed | 1 (author display) |
| Feature added | 1 (model param) |
| Learning captured | 1 |

---

## Tags

`forum` `mcp` `author` `model-detection` `bugfix`

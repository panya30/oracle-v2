# Session Retrospective

**Date**: 2026-01-06
**Time**: 19:13 - 19:30 GMT+7
**Duration**: ~17 minutes
**Focus**: Fix vector search in Oracle HTTP server using claude-mem pattern

## Summary

Fixed ChromaDB vector search in the Oracle HTTP server by adopting the same architecture pattern used in claude-mem. The key insight was that the HTTP server (port 37778) can safely use ChromaMcpClient since it's not an MCP server and has no stdio conflicts. Implemented auto-reconnect logic, proper score normalization for cosine distance, and hybrid search combining FTS + vector results.

## What We Built

### Files Modified
- `src/chroma-mcp.ts` - Complete rewrite with claude-mem pattern
- `src/server/handlers.ts` - Added ChromaMcpClient singleton + hybrid search
- `src/server.ts` - Made /search endpoint async
- `src/index.ts` - Minor cleanup of old collection reference
- `frontend/src/pages/Activity.tsx` - Added refresh button (from earlier in session)

### Key Changes

1. **ChromaMcpClient Rewrite** (`src/chroma-mcp.ts`):
   - `connect()` with auto-reconnect on "Not connected" errors
   - `resetConnection()` to clean up dead connections
   - `close()` to properly terminate chroma-mcp subprocess
   - Query retry logic when connection dies

2. **HTTP Server Hybrid Search** (`src/server/handlers.ts`):
   ```typescript
   // Singleton ChromaMcpClient
   let chromaClient: ChromaMcpClient | null = null;
   function getChromaClient(): ChromaMcpClient { ... }

   // Score normalization (cosine distance 0-2 → similarity 0-1)
   const similarity = Math.max(0, 1 - distance / 2);

   // Hybrid scoring: max(fts, vector) + 0.1 bonus
   const maxScore = Math.max(existing.score || 0, r.score || 0);
   seen.set(r.id, { ...existing, score: Math.min(1, maxScore + 0.1), source: 'hybrid' });
   ```

3. **Async /search Endpoint** (`src/server.ts`):
   - Wrapped in async IIFE since main handler is sync
   - Passes `mode` parameter (hybrid/fts/vector)

## AI Diary (Required)

This session was a satisfying debugging journey. The initial symptom was simple - vector search via MCP returned 0 results - but the root cause was subtle: stdio conflict between the MCP server and chroma-mcp subprocess.

I initially tried fixing it within the MCP server itself, adding pre-connect logic and various workarounds. None worked. The "Not connected" errors in `/tmp/oracle-chroma-debug.log` kept appearing. Then the user pointed me to claude-mem as a reference implementation.

Studying claude-mem's `ChromaSync` class was illuminating. They had the same architecture - MCP server uses stdio, chroma-mcp subprocess also needs stdio - but they solved it elegantly by keeping the ChromaDB integration in the HTTP worker, not the MCP server. The HTTP server has no stdio constraints.

The scoring issues were interesting too. ChromaDB returns cosine distances (0-2 range), not similarities. My initial `1 - distance` formula gave negative scores for distances > 1. The fix was simple: `1 - distance/2` to map the full range to 0-1.

The hybrid scoring also needed work. Averaging FTS and vector scores (my first approach) actually penalized good vector matches. Using `max + bonus` made much more sense semantically.

## Lessons Learned

- **Pattern**: When running MCP-in-MCP (calling another MCP server from your MCP server), stdio conflicts occur. Solution: delegate to a non-MCP service layer (HTTP server).

- **Pattern**: ChromaDB cosine distances range 0-2, not 0-1. Use `1 - distance/2` for proper similarity scores.

- **Pattern**: For hybrid search, use `max(score_a, score_b) + bonus` not `average(score_a, score_b)`. Averaging penalizes strong single-source matches.

- **Discovery**: The claude-mem architecture is well-designed for this exact problem. Worth studying for similar MCP integration challenges.

## Honest Feedback

What went well:
- User's "can we copy?" suggestion was the right call - learning from working code beats debugging in circles
- Debug logging (`[Hybrid]` prefixes) quickly revealed the scoring issues
- Incremental testing (vector-only → hybrid) isolated problems

What could improve:
- I should have checked claude-mem's implementation earlier instead of trying multiple workarounds
- The initial "Not connected" error logs should have immediately suggested connection lifecycle issues
- Spent time on bash command syntax issues that slowed testing

## Next Steps

- [ ] Remove debug logging from handlers.ts before committing
- [ ] Consider adding connection health check endpoint
- [ ] Test vector search via MCP (should now work since HTTP server handles it)
- [ ] Update MCP server's vectorSearch to call HTTP server instead of direct chroma

---

*Session completed successfully. Vector search operational.*

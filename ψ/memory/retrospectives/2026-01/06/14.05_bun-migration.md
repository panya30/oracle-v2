# Session Retrospective: Bun Runtime Migration

**Date**: 2026-01-06 14:05 GMT+7
**Duration**: ~90 minutes
**Focus**: Migrate oracle-v2 to Bun runtime + process lifecycle management
**Energy**: High, sustained flow

---

## Summary

Major runtime migration from Node.js/tsx to Bun. Added process lifecycle management (PID files, graceful shutdown). Fixed Arthur UI by adding /ask endpoint.

---

## What We Built

### Phase 1: Bun Migration (~45 min)
- Replaced `better-sqlite3` with `bun:sqlite` (6 files)
- Replaced `tsx` with `bun` in all scripts
- Replaced `vitest` with `bun:test`
- Removed npm/pnpm lock files, added `bun.lock`
- Version bump to 0.3.0

### Phase 2: Process Lifecycle (~15 min)
- Copied bun-process-manager source inline (5 files)
- Added PID file tracking (`worker.pid`)
- Added graceful shutdown on SIGTERM/SIGINT
- Database closes cleanly on exit

### Phase 3: Arthur UI Fix (~10 min)
- Discovered Arthur UI calls `/ask` endpoint (didn't exist)
- Added `POST /ask` that wraps `/consult`
- Arthur now returns Oracle guidance to queries

---

## AI Diary

Started by reviewing open issues - found #15 (bun-process-manager adoption). User wanted to understand the migration before implementing, so spent time explaining:
- Driver migration vs schema migration (no DB changes needed)
- API compatibility (bun:sqlite nearly identical to better-sqlite3)
- Benefits (10x faster startup, fewer dependencies)

User asked good clarifying questions ("why not DB migration?", "where database at home?"). Appreciated the back-and-forth - it built confidence before the big change.

The `gogogo` phase was smooth. 46 tests passed on first run after fixing dist/ directory issue. Regression tests via curl all passed.

Unexpected discovery: Arthur UI existed but was broken! The dev-browser skill helped debug - we could see it calling `/ask` and getting 404. Quick 10-line fix connected it to Oracle.

---

## Honest Feedback

### What Worked Well
- **Explanation before execution**: User understood what would change
- **Phase-based plan**: Clear milestones in issue #16
- **Inline process-manager**: No external dependency headaches
- **dev-browser for testing**: Saw exactly what user sees

### What Could Be Better
- **PID file location**: Currently `worker.pid` in repo root, should be in data dir
- **Database location**: Still hardcoded to Nat-s-Agents repo, should be configurable
- **Arthur response format**: Raw guidance text, could be cleaner

### Surprises
- bun:sqlite API compatibility was excellent
- 46 tests passed without modification (just import change)
- Arthur UI was a hidden feature waiting to work

---

## Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Runtime | Bun | 10x faster, built-in SQLite, same as claude-mem |
| process-manager | Inline copy | Avoid npm dependency, full control |
| Drizzle adapter | bun-sqlite | Same schema, just different driver |
| /ask endpoint | Wrap /consult | Minimal change, reuse existing logic |

---

## Files Changed

### Modified (8)
```
package.json              - Bun scripts, removed better-sqlite3
src/db/index.ts           - bun:sqlite import
src/server/db.ts          - bun:sqlite import
src/index.ts              - bun:sqlite import
src/indexer.ts            - bun:sqlite import
src/server.ts             - Process lifecycle + /ask endpoint
src/oracle-core.test.ts   - bun:test import
.gitignore                - Added *.pid
```

### Added (6)
```
bun.lock                           - Bun lockfile
src/process-manager/index.ts       - Module exports
src/process-manager/ProcessManager.ts
src/process-manager/HealthMonitor.ts
src/process-manager/GracefulShutdown.ts
src/process-manager/logger.ts
```

### Removed (2)
```
package-lock.json
pnpm-lock.yaml
```

---

## Test Results

- **Unit tests**: 46/46 pass (bun test)
- **Health endpoint**: Working
- **Search endpoint**: Working
- **Decisions endpoint**: Working
- **Forum threads**: Working
- **Arthur /ask**: Working
- **Graceful shutdown**: PID cleaned on exit

---

## Session Stats

| Metric | Value |
|--------|-------|
| Duration | ~90 min |
| Commits | 2 |
| Issues closed | 2 (#15, #16) |
| Files created | 6 |
| Files modified | 8 |
| Files removed | 2 |
| Tests passing | 46 |

---

## Lessons Learned

1. **bun:sqlite is drop-in replacement** - API nearly identical to better-sqlite3
2. **Inline dependencies > npm links** - Full control, no resolution issues
3. **dev-browser reveals hidden bugs** - Arthur UI was broken but nobody knew
4. **Process lifecycle matters** - PID files + graceful shutdown = production ready

---

## Next Steps

- [ ] Move database to ~/.oracle-v2/ (configurable data dir)
- [ ] Move PID file to data dir
- [ ] Improve Arthur response formatting
- [ ] Add more Arthur UI features (context, memory)

---

## Tags

`bun` `migration` `runtime` `process-manager` `arthur` `sqlite`
